{
  "kind": "Stateful",
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "triggers": {
      "DefaultReceiveLocation": {
        "type": "Request",
        "kind": "Http"
      }
    },
    "actions": {
      "shouldTerminate": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "shouldTerminate",
              "type": "boolean",
              "value": false
            }
          ]
        },
        "runAfter": {}
      },
      "terminateMessage": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "terminateMessage",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "shouldTerminate": [
            "SUCCEEDED"
          ]
        }
      },
      "retryCount": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "retryCount",
              "type": "integer",
              "value": 0
            }
          ]
        },
        "runAfter": {
          "terminateMessage": [
            "SUCCEEDED"
          ]
        }
      },
      "userID": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "userID",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "retryCount": [
            "SUCCEEDED"
          ]
        }
      },
      "ReturnProfile": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "ReturnProfile",
              "type": "object",
              "value": null
            }
          ]
        },
        "runAfter": {
          "userID": [
            "SUCCEEDED"
          ]
        }
      },
      "bIntervention": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "bIntervention",
              "type": "boolean",
              "value": false
            }
          ]
        },
        "runAfter": {
          "ReturnProfile": [
            "SUCCEEDED"
          ]
        }
      },
      "ConstructQueryMessage_a76a0977": {
        "type": "Compose",
        "inputs": "@'QueryMessage.partnerID = userID'",
        "runAfter": {
          "bIntervention": [
            "SUCCEEDED"
          ]
        }
      },
      "IntializeOutMessage_3579b1c8": {
        "type": "Compose",
        "inputs": "@'ReturnProfile = Microsoft.Samples.BizTalk.Litware.Utilities.ResourceHelper.GetEmptyUserMessage()'",
        "runAfter": {
          "ConstructQueryMessage_a76a0977": [
            "SUCCEEDED"
          ]
        }
      },
      "Until": {
        "type": "Until",
        "expression": "@greaterOrEquals(variables('retryCount'), 3)",
        "limit": {
          "count": 3,
          "timeout": "PT1H"
        },
        "actions": {
          "GetProfileForEmailNotificationScope": {
            "type": "Scope",
            "actions": {
              "SendUserInfoRequest": {
                "type": "Http",
                "inputs": {
                  "method": "POST",
                  "uri": "http://localhost/service",
                  "body": "@triggerBody()",
                  "headers": {
                    "Content-Type": "application/json"
                  }
                },
                "runAfter": {}
              },
              "ReceiveUserInfo": {
                "type": "Compose",
                "inputs": "// Unmapped: Response Receive response from GetProfilePort (BizTalk correlation pattern - requires manual configuration)",
                "runAfter": {
                  "SendUserInfoRequest": [
                    "SUCCEEDED"
                  ]
                }
              },
              "ConstructReturnMessage_eae858bd": {
                "type": "Compose",
                "inputs": "@'ReturnProfile = Microsoft.Samples.BizTalk.Litware.Utilities.XmlHelper.ConvertStringToXml(Profile.GetPartnerResult)'",
                "runAfter": {
                  "ReceiveUserInfo": [
                    "SUCCEEDED"
                  ]
                }
              },
              "Breakloop": {
                "type": "Compose",
                "inputs": "@'bIntervention = false;\r\nretryCount = 3'",
                "runAfter": {
                  "ConstructReturnMessage_eae858bd": [
                    "SUCCEEDED"
                  ]
                }
              },
              "CatchGetProfileException": {
                "type": "Scope",
                "actions": {
                  "Count": {
                    "type": "Compose",
                    "inputs": "@'retryCount = retryCount + 1'",
                    "runAfter": {}
                  },
                  "Terminate_4d51da26": {
                    "type": "If",
                    "expression": "@less(variables('retryCount'), 3)",
                    "actions": {
                      "Log_Susp_Error_9379a91b": {
                        "type": "Compose",
                        "inputs": "@concat('WriteEntry(\"Litware Scenario\", \"Failed to get profile of partner \"', variables('userID'), ' from TPM system. Orchestration suspended due to error ', 'exp')",
                        "runAfter": {}
                      },
                      "Set_shouldTerminate_Suspend_3d69e19a": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "shouldTerminate",
                          "value": true
                        },
                        "runAfter": {
                          "Log_Susp_Error_9379a91b": [
                            "SUCCEEDED"
                          ]
                        }
                      },
                      "Set_terminateMessage_Suspend_3d69e19a": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "terminateMessage",
                          "value": "exp.Message;"
                        },
                        "runAfter": {
                          "Set_shouldTerminate_Suspend_3d69e19a": [
                            "SUCCEEDED"
                          ]
                        }
                      }
                    },
                    "else": {
                      "actions": {
                        "Log_Term_Error_ca485763": {
                          "type": "Compose",
                          "inputs": "@concat('WriteEntry(\"Litware Scenario\", \"Failed to get profile of partner \"', variables('userID'), ' from TPM system. Returing failure due to ', 'exp')",
                          "runAfter": {}
                        },
                        "Intervention_56b791e9": {
                          "type": "Compose",
                          "inputs": "@'bIntervention = true'",
                          "runAfter": {
                            "Log_Term_Error_ca485763": [
                              "SUCCEEDED"
                            ]
                          }
                        }
                      }
                    },
                    "runAfter": {
                      "Count": [
                        "SUCCEEDED"
                      ]
                    }
                  }
                },
                "runAfter": {
                  "Breakloop": [
                    "FAILED",
                    "TIMEDOUT",
                    "SKIPPED"
                  ]
                }
              }
            },
            "runAfter": {}
          }
        },
        "runAfter": {
          "IntializeOutMessage_3579b1c8": [
            "SUCCEEDED"
          ]
        }
      },
      "DefaultSendPort": {
        "type": "ServiceProvider",
        "inputs": {
          "parameters": {
            "entityName": "queue",
            "message": "@triggerBody()",
            "sessionId": "",
            "contentType": "application/json"
          },
          "serviceProviderConfiguration": {
            "connectionName": "servicebus",
            "operationId": "sendMessage",
            "serviceProviderId": "/serviceProviders/serviceBus"
          }
        },
        "runAfter": {
          "Check_Terminate_Until": [
            "SUCCEEDED"
          ]
        }
      },
      "Check_Terminate_Until": {
        "type": "If",
        "expression": "@equals(variables('shouldTerminate'), true)",
        "actions": {
          "Terminate_Until": {
            "type": "Terminate",
            "inputs": {
              "runStatus": "Failed",
              "runError": {
                "code": "Terminated",
                "message": "@variables('terminateMessage')"
              }
            },
            "runAfter": {}
          }
        },
        "else": {
          "actions": {}
        },
        "runAfter": {
          "Until": [
            "SUCCEEDED",
            "FAILED",
            "TIMEDOUT"
          ]
        }
      }
    },
    "outputs": {},
    "metadata": {
      "detectedPatterns": [
        {
          "name": "Aggregator",
          "description": "Collect and combine multiple messages into a single message",
          "recommendation": "Use Batch trigger (Service Bus/RabbitMQ/Kafka) or stateful workflow with Until loop"
        },
        {
          "name": "Splitter",
          "description": "Split a single message into multiple messages",
          "recommendation": "Use For-Each loop with dynamic array from message"
        },
        {
          "name": "Exception Handling & Compensation",
          "description": "Handle errors and perform compensating actions",
          "recommendation": "Use Scope action with Configure Run After for error handling"
        }
      ],
      "optimizationApplied": true,
      "generatedBy": "BizTalk to Logic Apps Refactoring Tool",
      "generatedAt": "2026-02-15T15:30:12.8032823Z"
    }
  }
}