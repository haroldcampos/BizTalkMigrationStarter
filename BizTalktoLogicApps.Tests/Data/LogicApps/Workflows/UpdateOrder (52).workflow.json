{
  "kind": "Stateful",
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "triggers": {
      "DefaultReceiveLocation": {
        "type": "Request",
        "kind": "Http"
      }
    },
    "actions": {
      "partnerName": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "partnerName",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {}
      },
      "errMsg": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "errMsg",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "partnerName": [
            "SUCCEEDED"
          ]
        }
      },
      "soldToName": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "soldToName",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "errMsg": [
            "SUCCEEDED"
          ]
        }
      },
      "result": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "result",
              "type": "boolean",
              "value": false
            }
          ]
        },
        "runAfter": {
          "soldToName": [
            "SUCCEEDED"
          ]
        }
      },
      "retryCount": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "retryCount",
              "type": "integer",
              "value": 0
            }
          ]
        },
        "runAfter": {
          "result": [
            "SUCCEEDED"
          ]
        }
      },
      "destination": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "destination",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "retryCount": [
            "SUCCEEDED"
          ]
        }
      },
      "partner": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "partner",
              "type": "object",
              "value": null
            }
          ]
        },
        "runAfter": {
          "destination": [
            "SUCCEEDED"
          ]
        }
      },
      "bInquiryStatus": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "bInquiryStatus",
              "type": "boolean",
              "value": false
            }
          ]
        },
        "runAfter": {
          "partner": [
            "SUCCEEDED"
          ]
        }
      },
      "Name": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "Name",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "bInquiryStatus": [
            "SUCCEEDED"
          ]
        }
      },
      "Get_Sender_Info": {
        "type": "Compose",
        "inputs": "@'//partnerName = POChgMsg(MessageTracking.PartyName);\r\npartner = POChangeRoleLink(Microsoft.XLANGs.BaseTypes.SourceParty);\r\npartnerName = partner.Name;\r\nsoldToName = POChgMsg(Microsoft.Samples.BizTalk.Litware.Schemas.SoldToName)'",
        "runAfter": {
          "Name": [
            "SUCCEEDED"
          ]
        }
      },
      "Is_Sender_Valid_25c4b12b": {
        "type": "If",
        "expression": "@equals(variables('partnerName'), variables('soldToName'))",
        "actions": {
          "Check_PO_Existance_25ad14e6": {
            "type": "Scope",
            "actions": {
              "Construct_Inquiry_563c1c14": {
                "type": "Xslt",
                "inputs": {
                  "content": "@triggerBody()",
                  "map": {
                    "name": "PurchaseOrder_To_Inquiry",
                    "type": "Xslt"
                  },
                  "transformOptions": "ApplyXsltTemplates"
                },
                "runAfter": {}
              },
              "CheckOrderExists": {
                "type": "Workflow",
                "inputs": {
                  "host": {
                    "workflow": {
                      "id": "CheckOrderExists"
                    }
                  },
                  "body": {
                    "message": "@triggerBody()"
                  }
                },
                "runAfter": {
                  "Construct_Inquiry_563c1c14": [
                    "SUCCEEDED"
                  ]
                }
              }
            },
            "runAfter": {}
          },
          "Is_PO_Exist_a754e36b": {
            "type": "If",
            "expression": "@equals(variables('bInquiryStatus'), true)",
            "actions": {
              "Until_ea2bd1fe": {
                "type": "Until",
                "expression": "@greaterOrEquals(variables('retryCount'), 3)",
                "limit": {
                  "count": 3,
                  "timeout": "PT1H"
                },
                "actions": {
                  "Update_PO": {
                    "type": "Scope",
                    "actions": {
                      "Send_PO_Chg": {
                        "type": "Http",
                        "inputs": {
                          "method": "POST",
                          "uri": "http://localhost/service",
                          "body": "@triggerBody()",
                          "headers": {
                            "Content-Type": "application/json"
                          }
                        },
                        "runAfter": {}
                      },
                      "Recv_Ack": {
                        "type": "Compose",
                        "inputs": "// Unmapped: Response Receive response from SendOrderChg (BizTalk correlation pattern - requires manual configuration)",
                        "runAfter": {
                          "Send_PO_Chg": [
                            "SUCCEEDED"
                          ]
                        }
                      },
                      "Break_Loop": {
                        "type": "Compose",
                        "inputs": "@'retryCount = 3'",
                        "runAfter": {
                          "Recv_Ack": [
                            "SUCCEEDED"
                          ]
                        }
                      },
                      "OrderSystemBusinessException": {
                        "type": "Scope",
                        "actions": {
                          "Terminate_Update": {
                            "type": "Terminate",
                            "inputs": {
                              "runStatus": "Failed",
                              "runError": {
                                "code": "Terminated",
                                "message": "OrderSystemBusinessException.Message;"
                              }
                            },
                            "runAfter": {}
                          }
                        },
                        "runAfter": {
                          "Break_Loop": [
                            "FAILED",
                            "TIMEDOUT",
                            "SKIPPED"
                          ]
                        }
                      },
                      "OrderSystemSystemException": {
                        "type": "Scope",
                        "actions": {
                          "Inc_Retry_Count": {
                            "type": "Compose",
                            "inputs": "@'retryCount = retryCount + 1'",
                            "runAfter": {}
                          },
                          "Check_Retry_Count_1e34dbdd": {
                            "type": "If",
                            "expression": "@less(variables('retryCount'), 3)",
                            "actions": {
                              "Log_Susp_Error_e76e13bd": {
                                "type": "Compose",
                                "inputs": "@concat('\"', 'OrderSystemSystemException')",
                                "runAfter": {}
                              },
                              "Suspend_Update_c2244489": {
                                "type": "Terminate",
                                "inputs": {
                                  "runStatus": "Failed",
                                  "runError": {
                                    "code": "Terminated",
                                    "message": "OrderSystemSystemException.Message;"
                                  }
                                },
                                "runAfter": {
                                  "Log_Susp_Error_e76e13bd": [
                                    "SUCCEEDED"
                                  ]
                                }
                              }
                            },
                            "else": {
                              "actions": {
                                "Log_Term_Error_12763700": {
                                  "type": "Compose",
                                  "inputs": "@concat('\"', 'OrderSystemSystemException')",
                                  "runAfter": {}
                                },
                                "Terminate_Update_9fb0af01": {
                                  "type": "Terminate",
                                  "inputs": {
                                    "runStatus": "Failed",
                                    "runError": {
                                      "code": "Terminated",
                                      "message": "OrderSystemSystemException.Message;"
                                    }
                                  },
                                  "runAfter": {
                                    "Log_Term_Error_12763700": [
                                      "SUCCEEDED"
                                    ]
                                  }
                                }
                              }
                            },
                            "runAfter": {
                              "Inc_Retry_Count": [
                                "SUCCEEDED"
                              ]
                            }
                          }
                        },
                        "runAfter": {
                          "Break_Loop": [
                            "FAILED",
                            "TIMEDOUT",
                            "SKIPPED"
                          ]
                        }
                      },
                      "Catch_Exception": {
                        "type": "Scope",
                        "actions": {
                          "Inc_Retry_Count_1": {
                            "type": "Compose",
                            "inputs": "@'retryCount = retryCount + 1'",
                            "runAfter": {}
                          },
                          "Check_Retry_Count_94c1efe0": {
                            "type": "If",
                            "expression": "@less(variables('retryCount'), 3)",
                            "actions": {
                              "Log_Susp_Error_210dbf59": {
                                "type": "Compose",
                                "inputs": "@concat('\"', 'exp')",
                                "runAfter": {}
                              },
                              "Suspend_Update_ff5db415": {
                                "type": "Terminate",
                                "inputs": {
                                  "runStatus": "Failed",
                                  "runError": {
                                    "code": "Terminated",
                                    "message": "exp.Message;"
                                  }
                                },
                                "runAfter": {
                                  "Log_Susp_Error_210dbf59": [
                                    "SUCCEEDED"
                                  ]
                                }
                              }
                            },
                            "else": {
                              "actions": {
                                "Log_Term_Error_eaf8d282": {
                                  "type": "Compose",
                                  "inputs": "@concat('\"', 'exp')",
                                  "runAfter": {}
                                },
                                "Terminate_Update_6734684f": {
                                  "type": "Terminate",
                                  "inputs": {
                                    "runStatus": "Failed",
                                    "runError": {
                                      "code": "Terminated",
                                      "message": "exp.Message;"
                                    }
                                  },
                                  "runAfter": {
                                    "Log_Term_Error_eaf8d282": [
                                      "SUCCEEDED"
                                    ]
                                  }
                                }
                              }
                            },
                            "runAfter": {
                              "Inc_Retry_Count_1": [
                                "SUCCEEDED"
                              ]
                            }
                          }
                        },
                        "runAfter": {
                          "Break_Loop": [
                            "FAILED",
                            "TIMEDOUT",
                            "SKIPPED"
                          ]
                        }
                      }
                    },
                    "runAfter": {}
                  }
                },
                "runAfter": {}
              },
              "Vendor_Confirm_b7d88c6a": {
                "type": "Workflow",
                "inputs": {
                  "host": {
                    "workflow": {
                      "id": "ConfirmOrderWithVendors"
                    }
                  },
                  "body": {
                    "message": "@triggerBody()"
                  }
                },
                "runAfter": {
                  "Until_ea2bd1fe": [
                    "SUCCEEDED"
                  ]
                }
              },
              "Inform_Broker_8bd1a5f9": {
                "type": "Scope",
                "actions": {
                  "Get_Broker_Profile": {
                    "type": "Workflow",
                    "inputs": {
                      "host": {
                        "workflow": {
                          "id": "GetUserProfile"
                        }
                      },
                      "body": {
                        "message": "@triggerBody()"
                      }
                    },
                    "runAfter": {}
                  },
                  "Get_Email": {
                    "type": "Compose",
                    "inputs": "@'destination = Microsoft.Samples.BizTalk.Litware.Utilities.XmlHelper.GetPartnerEmail(ProfileMsg)'",
                    "runAfter": {
                      "Get_Broker_Profile": [
                        "SUCCEEDED"
                      ]
                    }
                  },
                  "Broker_Confirm": {
                    "type": "Workflow",
                    "inputs": {
                      "host": {
                        "workflow": {
                          "id": "ConfirmOrderWithBroker"
                        }
                      },
                      "body": {
                        "message": "@triggerBody()"
                      }
                    },
                    "runAfter": {
                      "Get_Email": [
                        "SUCCEEDED"
                      ]
                    }
                  }
                },
                "runAfter": {
                  "Vendor_Confirm_b7d88c6a": [
                    "SUCCEEDED"
                  ]
                }
              }
            },
            "else": {
              "actions": {
                "Notify_Admin_5a20e877": {
                  "type": "Compose",
                  "inputs": "@'errMsg = System.String.Format(\"Unable to find Order where Order ID = {0} and Sold To Name = {1}\", InquiryMsg.Request.OrderGroupId, InquiryMsg.Request.SoldToName);\r\nSystem.Diagnostics.EventLog.WriteEntry(\"Litware Scenario\", errMsg, System.Diagnostics.EventLogEntryType.Warning)'",
                  "runAfter": {}
                }
              }
            },
            "runAfter": {
              "Check_PO_Existance_25ad14e6": [
                "SUCCEEDED"
              ]
            }
          }
        },
        "else": {
          "actions": {
            "Notify_Admin_99372bf0": {
              "type": "Compose",
              "inputs": "@'errMsg = System.String.Format(\"Sender ({0}) is not the same as Sold To Name ({1}).\", partnerName, soldToName);\r\nSystem.Diagnostics.EventLog.WriteEntry(\"Litware Scenario\", errMsg, System.Diagnostics.EventLogEntryType.Error)'",
              "runAfter": {}
            }
          }
        },
        "runAfter": {
          "Get_Sender_Info": [
            "SUCCEEDED"
          ]
        }
      },
      "DefaultSendPort": {
        "type": "ServiceProvider",
        "inputs": {
          "parameters": {
            "entityName": "queue",
            "message": "@triggerBody()",
            "sessionId": "",
            "contentType": "application/json"
          },
          "serviceProviderConfiguration": {
            "connectionName": "servicebus",
            "operationId": "sendMessage",
            "serviceProviderId": "/serviceProviders/serviceBus"
          }
        },
        "runAfter": {
          "Is_Sender_Valid_25c4b12b": [
            "SUCCEEDED"
          ]
        }
      }
    },
    "outputs": {}
  }
}