{
  "kind": "Stateful",
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "triggers": {
      "DefaultReceiveLocation": {
        "type": "Request",
        "kind": "Http"
      }
    },
    "actions": {
      "tipoProceso": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "tipoProceso",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {}
      },
      "xmlRespuestaRecepcionPago": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "xmlRespuestaRecepcionPago",
              "type": "object",
              "value": null
            }
          ]
        },
        "runAfter": {
          "tipoProceso": [
            "SUCCEEDED"
          ]
        }
      },
      "respuestaProcesamiento": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "respuestaProcesamiento",
              "type": "object",
              "value": null
            }
          ]
        },
        "runAfter": {
          "xmlRespuestaRecepcionPago": [
            "SUCCEEDED"
          ]
        }
      },
      "recepcionArchivos": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "recepcionArchivos",
              "type": "object",
              "value": null
            }
          ]
        },
        "runAfter": {
          "respuestaProcesamiento": [
            "SUCCEEDED"
          ]
        }
      },
      "reproceso": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "reproceso",
              "type": "boolean",
              "value": false
            }
          ]
        },
        "runAfter": {
          "recepcionArchivos": [
            "SUCCEEDED"
          ]
        }
      },
      "reprocesoPagosDominio": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "reprocesoPagosDominio",
              "type": "object",
              "value": null
            }
          ]
        },
        "runAfter": {
          "reproceso": [
            "SUCCEEDED"
          ]
        }
      },
      "reprocesoPagos": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "reprocesoPagos",
              "type": "object",
              "value": null
            }
          ]
        },
        "runAfter": {
          "reprocesoPagosDominio": [
            "SUCCEEDED"
          ]
        }
      },
      "xmlMensajeContingencia": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "xmlMensajeContingencia",
              "type": "object",
              "value": null
            }
          ]
        },
        "runAfter": {
          "reprocesoPagos": [
            "SUCCEEDED"
          ]
        }
      },
      "procesoPago": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "procesoPago",
              "type": "object",
              "value": null
            }
          ]
        },
        "runAfter": {
          "xmlMensajeContingencia": [
            "SUCCEEDED"
          ]
        }
      },
      "fechaPago": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "fechaPago",
              "type": "object",
              "value": null
            }
          ]
        },
        "runAfter": {
          "procesoPago": [
            "SUCCEEDED"
          ]
        }
      },
      "RecepcionContingencia": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "RecepcionContingencia",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "fechaPago": [
            "SUCCEEDED"
          ]
        }
      },
      "RecepcionRespuestaPago": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "RecepcionRespuestaPago",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "RecepcionContingencia": [
            "SUCCEEDED"
          ]
        }
      },
      "Inicializa_variables": {
        "type": "Compose",
        "inputs": "@'recepcionArchivos = new Sat.Scade.Pagos.Modelo.Comun.RecepcionArchivosBanco();\r\nrespuestaProcesamiento = new Sat.Scade.Pagos.Modelo.Comun.RespuestaProcesamiento();\r\nreproceso = false'",
        "runAfter": {
          "RecepcionRespuestaPago": [
            "SUCCEEDED"
          ]
        }
      },
      "CoordinaProcesos": {
        "type": "Scope",
        "actions": {
          "Recupera_tipo_de_recepcion": {
            "type": "Compose",
            "inputs": "@'reproceso = false;\r\nSystem.Diagnostics.EventLog.WriteEntry(\"CoordinadorProcesos\", \"Accede al coordinador de eventos\");\r\nSat.Scade.PagosCore.Dominio.Utilerias.EscribeMensaje(RecepcionPago);\r\nrecepcionArchivos = (Sat.Scade.Pagos.Modelo.Comun.RecepcionArchivosBanco)Sat.Scade.PagosCore.Dominio.Utilerias.Deserializa(typeof(Sat.Scade.Pagos.Modelo.Comun.RecepcionArchivosBanco),RecepcionPago);\r\nrespuestaProcesamiento.IdProcesoPago = recepcionArchivos.IdProceso'",
            "runAfter": {}
          },
          "Es_recepción_banco_7e963a4d": {
            "type": "If",
            "expression": "@'recepcionArchivos.Procesos == Sat.Scade.Pagos.Modelo.Comun.Procesos.RecepcionArchivosPagos ||\r\nrecepcionArchivos.Procesos == Sat.Scade.Pagos.Modelo.Comun.Procesos.ProcesoCeros ||\r\nrecepcionArchivos.Procesos == Sat.Scade.Pagos.Modelo.Comun.Procesos.ComplementoNepeCeros'",
            "actions": {
              "Verifica_si_es_proceso_pago_24d95ae6": {
                "type": "If",
                "expression": "@equals(variables('recepcionArchivos')?['Procesos'], 'RecepcionArchivosPagos')",
                "actions": {
                  "StartOrchestration_1_bb7ac7b4": {
                    "type": "Workflow",
                    "inputs": {
                      "host": {
                        "workflow": {
                          "id": "RecepcionPagos"
                        }
                      },
                      "body": {
                        "message": "@triggerBody()"
                      }
                    },
                    "runAfter": {}
                  }
                },
                "else": {
                  "actions": {
                    "inicializa_proceso_3c96b020": {
                      "type": "Compose",
                      "inputs": "@'procesoPago = new Sat.Scade.Pagos.Modelo.Comun.ProcesosPagos(); \r\nprocesoPago.IdProcesoPago = recepcionArchivos.IdProceso;\r\nprocesoPago.EstadoProcesoPago = recepcionArchivos.Estado;\r\nprocesoPago.TipoProceso = recepcionArchivos.TipoProceso;\r\nprocesoPago.Reproceso = false'",
                      "runAfter": {}
                    },
                    "StartOrchestration_6_41c76b4b": {
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflow": {
                            "id": "ProcesaArchivosAceptados"
                          }
                        },
                        "body": {
                          "message": "@triggerBody()"
                        }
                      },
                      "runAfter": {
                        "inicializa_proceso_3c96b020": [
                          "SUCCEEDED"
                        ]
                      }
                    }
                  }
                },
                "runAfter": {}
              },
              "llamada_Exitosa_f4945e1d": {
                "type": "Compose",
                "inputs": "@'respuestaProcesamiento.Resultado = true'",
                "runAfter": {
                  "Verifica_si_es_proceso_pago_24d95ae6": [
                    "SUCCEEDED"
                  ]
                }
              }
            },
            "else": {
              "actions": {
                "Decide_1_f4991773": {
                  "type": "If",
                  "expression": "@'recepcionArchivos.Procesos == Sat.Scade.Pagos.Modelo.Comun.Procesos.ContingenciaNepeCeros  || \r\nrecepcionArchivos.Procesos == Sat.Scade.Pagos.Modelo.Comun.Procesos.ContingenciaNepeCerosReenvios'",
                  "actions": {
                    "Construye_Mensaje_Declaración_f033d42a": {
                      "type": "Compose",
                      "inputs": "@'RecepcionContingencia = RecepcionPago'",
                      "runAfter": {}
                    }
                  },
                  "else": {
                    "actions": {
                      "Receupera_datos_contingencia_0758d4a2": {
                        "type": "Scope",
                        "actions": {
                          "ObtieneDatos": {
                            "type": "Compose",
                            "inputs": "@'if (recepcionArchivos.Procesos != Sat.Scade.Pagos.Modelo.Comun.Procesos.ContingenciaNepeCeros)\r\n{\r\n    reprocesoPagosDominio = new Sat.Scade.PagosCore.Dominio.ReprocesaPagosDominio();\r\n    reprocesoPagos = reprocesoPagosDominio.ObtenerDatos(respuestaProcesamiento.IdProcesoPago);\r\n    reprocesoPagos.ArchivosBanco.Procesos = recepcionArchivos.Procesos;\r\n}\r\nelse\r\n{\r\n   reprocesoPagos = new Sat.Scade.PagosCore.Modelo.Dominio.ReprocesaPagos(); \r\n   reprocesoPagos.ArchivosBanco = recepcionArchivos;\r\n}'",
                            "runAfter": {}
                          },
                          "Construye_Mensaje_Declaración_f7a54f7a": {
                            "type": "Compose",
                            "inputs": "@'xmlMensajeContingencia = new System.Xml.XmlDataDocument();\r\nxmlMensajeContingencia = Sat.Scade.PagosCore.Dominio.Utilerias.Serializa(typeof(Sat.Scade.Pagos.Modelo.Comun.RecepcionArchivosBanco),reprocesoPagos.ArchivosBanco);\r\n\r\nRecepcionContingencia = xmlMensajeContingencia'",
                            "runAfter": {
                              "ObtieneDatos": [
                                "SUCCEEDED"
                              ]
                            }
                          }
                        },
                        "runAfter": {}
                      }
                    }
                  },
                  "runAfter": {}
                },
                "ObtieneDatos_8ac8407a": {
                  "type": "Compose",
                  "inputs": "@'System.Diagnostics.EventLog.WriteEntry(\"Pagos\",\"Obtiene datos\");\r\n    reprocesoPagosDominio = new Sat.Scade.PagosCore.Dominio.ReprocesaPagosDominio();\r\n    reprocesoPagos = reprocesoPagosDominio.ObtenerDatos(respuestaProcesamiento.IdProcesoPago);\r\n    reprocesoPagos.ArchivosBanco.Procesos = recepcionArchivos.Procesos;\r\nfechaPago = recepcionArchivos.FechaContingenciaCeros;\r\n\r\nSystem.Diagnostics.EventLog.WriteEntry(\"Pagos\",recepcionArchivos.Procesos.ToString())'",
                  "runAfter": {
                    "Decide_1_f4991773": [
                      "SUCCEEDED"
                    ]
                  }
                },
                "Es_minilote_ó_Pendiente_Marcación_afa113d0": {
                  "type": "If",
                  "expression": "@'recepcionArchivos.Procesos == Sat.Scade.Pagos.Modelo.Comun.Procesos.ContingenciaLCPendientes ||\r\nrecepcionArchivos.Procesos == Sat.Scade.Pagos.Modelo.Comun.Procesos.ContingenciaMinilote'",
                  "actions": {
                    "StartOrchestration_1_8189706c": {
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflow": {
                            "id": "RecepcionPagos"
                          }
                        },
                        "body": {
                          "message": "@triggerBody()"
                        }
                      },
                      "runAfter": {}
                    },
                    "llamada_Exitosa_f7c20725": {
                      "type": "Compose",
                      "inputs": "@'respuestaProcesamiento.Resultado = true'",
                      "runAfter": {
                        "StartOrchestration_1_8189706c": [
                          "SUCCEEDED"
                        ]
                      }
                    }
                  },
                  "else": {
                    "actions": {
                      "_Es_contingencia_Banco_30d92cef": {
                        "type": "If",
                        "expression": "@equals(variables('recepcionArchivos')?['Procesos'], 'ContingenciaBanco')",
                        "actions": {
                          "StartOrchestration_2_6b4cb422": {
                            "type": "Workflow",
                            "inputs": {
                              "host": {
                                "workflow": {
                                  "id": "GeneraEnviaAcuseBanco"
                                }
                              },
                              "body": {
                                "message": "@triggerBody()"
                              }
                            },
                            "runAfter": {}
                          },
                          "llamada_exitosa_ed1c98c9": {
                            "type": "Compose",
                            "inputs": "@'respuestaProcesamiento.Resultado = true'",
                            "runAfter": {
                              "StartOrchestration_2_6b4cb422": [
                                "SUCCEEDED"
                              ]
                            }
                          }
                        },
                        "else": {
                          "actions": {
                            "Es_contingencia_TESOFE_f9b2de89": {
                              "type": "If",
                              "expression": "@equals(variables('recepcionArchivos')?['Procesos'], 'ContingenciaTesofe')",
                              "actions": {
                                "StartOrchestration_3_687a878e": {
                                  "type": "Workflow",
                                  "inputs": {
                                    "host": {
                                      "workflow": {
                                        "id": "GeneraEnviaArchivoTesofe"
                                      }
                                    },
                                    "body": {
                                      "message": "@triggerBody()"
                                    }
                                  },
                                  "runAfter": {}
                                },
                                "llamada_exitosa_a57f8e10": {
                                  "type": "Compose",
                                  "inputs": "@'respuestaProcesamiento.Resultado = true'",
                                  "runAfter": {
                                    "StartOrchestration_3_687a878e": [
                                      "SUCCEEDED"
                                    ]
                                  }
                                }
                              },
                              "else": {
                                "actions": {
                                  "Es_contingencia_de_Lote_NEPE_d60a046d": {
                                    "type": "If",
                                    "expression": "@'recepcionArchivos.Procesos  == Sat.Scade.Pagos.Modelo.Comun.Procesos.ContingenciaNepePagos || \r\nrecepcionArchivos.Procesos  == Sat.Scade.Pagos.Modelo.Comun.Procesos.ContingenciaNepeCeros ||\r\nrecepcionArchivos.Procesos  == Sat.Scade.Pagos.Modelo.Comun.Procesos.ContingenciaNepeCerosReenvios'",
                                    "actions": {
                                      "llamada_exitosa_598fb421": {
                                        "type": "Compose",
                                        "inputs": "@'WriteEntry(\"Pagos\",\"Es contingencia lote NEPE\")'",
                                        "runAfter": {}
                                      },
                                      "StartOrchestration_4_6178f113": {
                                        "type": "Workflow",
                                        "inputs": {
                                          "host": {
                                            "workflow": {
                                              "id": "GeneraEnviaLoteNEPE"
                                            }
                                          },
                                          "body": {
                                            "message": "@triggerBody()"
                                          }
                                        },
                                        "runAfter": {
                                          "llamada_exitosa_598fb421": [
                                            "SUCCEEDED"
                                          ]
                                        }
                                      },
                                      "llamada_exitosa_2f254a51": {
                                        "type": "Compose",
                                        "inputs": "@'respuestaProcesamiento.Resultado = true'",
                                        "runAfter": {
                                          "StartOrchestration_4_6178f113": [
                                            "SUCCEEDED"
                                          ]
                                        }
                                      }
                                    },
                                    "else": {
                                      "actions": {
                                        "Es_contingencia_de_Cuenta_Tributaria_c65b22e5": {
                                          "type": "If",
                                          "expression": "@equals(variables('recepcionArchivos')?['Procesos'], 'ContingenciaCT')",
                                          "actions": {
                                            "StartOrchestration_5_d4ff2290": {
                                              "type": "Workflow",
                                              "inputs": {
                                                "host": {
                                                  "workflow": {
                                                    "id": "GeneraEnviaArchivoCT"
                                                  }
                                                },
                                                "body": {
                                                  "message": "@triggerBody()"
                                                }
                                              },
                                              "runAfter": {}
                                            },
                                            "llamada_exitosa_dd346fec": {
                                              "type": "Compose",
                                              "inputs": "@'respuestaProcesamiento.Resultado = true'",
                                              "runAfter": {
                                                "StartOrchestration_5_d4ff2290": [
                                                  "SUCCEEDED"
                                                ]
                                              }
                                            }
                                          },
                                          "else": {
                                            "actions": {
                                              "Opción_errónea_f9e094e6": {
                                                "type": "Compose",
                                                "inputs": "@'respuestaProcesamiento.Resultado = false;\r\nrespuestaProcesamiento.Mensaje = \"No se accedió a ninguna opción\"'",
                                                "runAfter": {}
                                              }
                                            }
                                          },
                                          "runAfter": {}
                                        }
                                      }
                                    },
                                    "runAfter": {}
                                  }
                                }
                              },
                              "runAfter": {}
                            }
                          }
                        },
                        "runAfter": {}
                      }
                    }
                  },
                  "runAfter": {
                    "ObtieneDatos_8ac8407a": [
                      "SUCCEEDED"
                    ]
                  }
                }
              }
            },
            "runAfter": {
              "Recupera_tipo_de_recepcion": [
                "SUCCEEDED"
              ]
            }
          },
          "Construye_mensaje_respuesta_7ccf0d59": {
            "type": "Compose",
            "inputs": "@'xmlRespuestaRecepcionPago = Sat.Scade.PagosCore.Dominio.Utilerias.Serializa(typeof(Sat.Scade.Pagos.Modelo.Comun.RespuestaProcesamiento),respuestaProcesamiento);\r\n\r\nRecepcionRespuestaPago = xmlRespuestaRecepcionPago'",
            "runAfter": {
              "Es_recepción_banco_7e963a4d": [
                "SUCCEEDED"
              ]
            }
          },
          "Captura_Excepción": {
            "type": "Scope",
            "actions": {
              "Datos_Error": {
                "type": "Compose",
                "inputs": "@'respuestaProcesamiento.Resultado = false;\r\nrespuestaProcesamiento.Mensaje = ExcepcionGenerica.Message'",
                "runAfter": {}
              },
              "Construye_mensaje_respuesta_fd015006": {
                "type": "Compose",
                "inputs": "@'xmlRespuestaRecepcionPago = Sat.Scade.PagosCore.Dominio.Utilerias.Serializa(typeof(Sat.Scade.Pagos.Modelo.Comun.RespuestaProcesamiento),respuestaProcesamiento);\r\n\r\nRecepcionRespuestaPago = xmlRespuestaRecepcionPago'",
                "runAfter": {
                  "Datos_Error": [
                    "SUCCEEDED"
                  ]
                }
              }
            },
            "runAfter": {
              "Construye_mensaje_respuesta_7ccf0d59": [
                "FAILED",
                "TIMEDOUT",
                "SKIPPED"
              ]
            }
          }
        },
        "runAfter": {
          "Inicializa_variables": [
            "SUCCEEDED"
          ]
        }
      },
      "Envía_Peticion": {
        "type": "Http",
        "inputs": {
          "method": "POST",
          "uri": "http://localhost/service",
          "body": "@triggerBody()",
          "headers": {
            "Content-Type": "application/json"
          }
        },
        "runAfter": {
          "CoordinaProcesos": [
            "SUCCEEDED"
          ]
        }
      },
      "DefaultSendPort": {
        "type": "ServiceProvider",
        "inputs": {
          "parameters": {
            "entityName": "queue",
            "message": "@triggerBody()",
            "sessionId": "",
            "contentType": "application/json"
          },
          "serviceProviderConfiguration": {
            "connectionName": "servicebus",
            "operationId": "sendMessage",
            "serviceProviderId": "/serviceProviders/serviceBus"
          }
        },
        "runAfter": {
          "Envía_Peticion": [
            "SUCCEEDED"
          ]
        }
      }
    },
    "outputs": {},
    "metadata": {
      "detectedPatterns": [
        {
          "name": "Request-Reply (Synchronous)",
          "description": "Synchronous request-response pattern",
          "recommendation": "Use Request trigger with Response action (built-in pattern)"
        },
        {
          "name": "Exception Handling & Compensation",
          "description": "Handle errors and perform compensating actions",
          "recommendation": "Use Scope action with Configure Run After for error handling"
        }
      ],
      "optimizationApplied": true,
      "generatedBy": "BizTalk to Logic Apps Refactoring Tool",
      "generatedAt": "2026-02-15T15:30:11.6307821Z"
    }
  }
}