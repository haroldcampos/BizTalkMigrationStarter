{
  "kind": "Stateful",
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "triggers": {
      "DefaultReceiveLocation": {
        "type": "Request",
        "kind": "Http"
      }
    },
    "actions": {
      "FailureReason": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "FailureReason",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {}
      },
      "ActivityID": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "ActivityID",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "FailureReason": [
            "SUCCEEDED"
          ]
        }
      },
      "HistoryInsertMsg": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "HistoryInsertMsg",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "ActivityID": [
            "SUCCEEDED"
          ]
        }
      },
      "Parallel_Branch_1_Placeholder": {
        "type": "Compose",
        "inputs": "Parallel branch 1",
        "runAfter": {
          "HistoryInsertMsg": [
            "SUCCEEDED"
          ]
        }
      },
      "Parallel_Branch_2_Placeholder": {
        "type": "Compose",
        "inputs": "Parallel branch 2",
        "runAfter": {
          "HistoryInsertMsg": [
            "SUCCEEDED"
          ]
        }
      },
      "BAM_Start": {
        "type": "Compose",
        "inputs": "@'// [BAM] Start collecting BAM data [Customer Order Request]\r\n\r\nActivityID = Microsoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.StartCollecting( CSROrderMsg.Header.ReqId )'",
        "runAfter": {
          "HistoryInsertMsg": [
            "SUCCEEDED"
          ]
        }
      },
      "BAM_Start_1": {
        "type": "Compose",
        "inputs": "@'// [BAM] Start collecting BAM data [Customer Order Request]\r\n\r\nActivityID = Microsoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.StartCollecting( CSROrderMsg.Header.ReqId )'",
        "runAfter": {
          "HistoryInsertMsg": [
            "SUCCEEDED"
          ]
        }
      },
      "BAM_Start_2": {
        "type": "Compose",
        "inputs": "@'// [BAM] Start collecting BAM data [Customer Order Request]\r\n\r\nActivityID = Microsoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.StartCollecting( CSROrderMsg.Header.ReqId )'",
        "runAfter": {
          "HistoryInsertMsg": [
            "SUCCEEDED"
          ]
        }
      },
      "BAM_Customer": {
        "type": "Compose",
        "inputs": "@'// [BAM] Update Activity [Customer Order Request] with [Received from CSR]\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.RequestReceivedFromCustomer(\r\n                ActivityID,                         // Activity ID\r\n                CSROrderMsg.RequestHeader.CRN,      // Customer ID\r\n                CSROrderMsg.RequestHeader.ORN,      // Order ID\r\n                CSROrderMsg.RequestHeader.ORNSeq,   // Order Sequence #\r\n                CSROrderMsg.Header.RequestType);    // Request Type'",
        "runAfter": {
          "BAM_Start_2": [
            "SUCCEEDED"
          ]
        }
      },
      "BAM_Customer_1": {
        "type": "Compose",
        "inputs": "@'// [BAM] Update Activity [Customer Order Request] with [Received from CSR]\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.RequestReceivedFromCustomer(\r\n                ActivityID,                         // Activity ID\r\n                CSROrderMsg.RequestHeader.CRN,      // Customer ID\r\n                CSROrderMsg.RequestHeader.ORN,      // Order ID\r\n                CSROrderMsg.RequestHeader.ORNSeq,   // Order Sequence #\r\n                CSROrderMsg.Header.RequestType);    // Request Type'",
        "runAfter": {
          "HistoryInsertMsg": [
            "SUCCEEDED"
          ]
        }
      },
      "BAM_Vendor": {
        "type": "Compose",
        "inputs": "@'// [BAM] Update Activity [Customer Order Request] with [Received from Vendor]\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.RequestReceivedFromVendor(\r\n                ActivityID,                         // Activity ID\r\n                CSROrderMsg.RequestHeader.CRN,      // Customer ID\r\n                CSROrderMsg.RequestHeader.ORN,      // Order ID\r\n                CSROrderMsg.RequestHeader.ORNSeq,   // Order Sequence #\r\n                CSROrderMsg.Header.RequestType);    // Request Type'",
        "runAfter": {
          "HistoryInsertMsg": [
            "SUCCEEDED"
          ]
        }
      },
      "BAM_Start_3": {
        "type": "Compose",
        "inputs": "@'// [BAM] Start collecting BAM data [Customer Order Request]\r\n\r\nActivityID = Microsoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.StartCollecting( CSROrderMsg.Header.ReqId )'",
        "runAfter": {
          "HistoryInsertMsg": [
            "SUCCEEDED"
          ]
        }
      },
      "BAM_Vendor_1": {
        "type": "Compose",
        "inputs": "@'// [BAM] Update Activity [Customer Order Request] with [Received from Vendor]\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.RequestReceivedFromVendor(\r\n                ActivityID,                         // Activity ID\r\n                CSROrderMsg.RequestHeader.CRN,      // Customer ID\r\n                CSROrderMsg.RequestHeader.ORN,      // Order ID\r\n                CSROrderMsg.RequestHeader.ORNSeq,   // Order Sequence #\r\n                CSROrderMsg.Header.RequestType);    // Request Type'",
        "runAfter": {
          "BAM_Start_3": [
            "SUCCEEDED"
          ]
        }
      },
      "Listen_For_Orders_Join": {
        "type": "Compose",
        "inputs": {
          "migrationWarning": "BizTalk Listen shape: only the FIRST branch should execute (race pattern). Logic Apps runs ALL branches in parallel. Manual review required.",
          "originalBizTalkShape": "Listen",
          "requiredAction": "Convert to Switch on status/timeout, or add Terminate actions to losing branches."
        },
        "runAfter": {
          "Parallel_Branch_1_Placeholder": [
            "SUCCEEDED"
          ],
          "Parallel_Branch_2_Placeholder": [
            "SUCCEEDED"
          ],
          "BAM_Start": [
            "SUCCEEDED"
          ],
          "BAM_Start_1": [
            "SUCCEEDED"
          ],
          "BAM_Customer": [
            "SUCCEEDED"
          ],
          "BAM_Customer_1": [
            "SUCCEEDED"
          ],
          "BAM_Vendor": [
            "SUCCEEDED"
          ],
          "BAM_Vendor_1": [
            "SUCCEEDED"
          ]
        }
      },
      "TRACE": {
        "type": "Compose",
        "inputs": "@'System.Diagnostics.Debug.WriteLine( \"\\n<BROKER>\\n\" );\r\nSystem.Diagnostics.Debug.WriteLine( \"   Req ID   : \" + CSROrderMsg.Header.ReqId );\r\nSystem.Diagnostics.Debug.WriteLine( \"   Req Type : \" + CSROrderMsg.Header.RequestType );\r\nSystem.Diagnostics.Debug.WriteLine( \"   Customer : \" + CSROrderMsg.RequestHeader.CRN );\r\nSystem.Diagnostics.Debug.WriteLine( \"   Order    : \" + CSROrderMsg.RequestHeader.ORN );\r\nSystem.Diagnostics.Debug.WriteLine( \"   Sequence : \" + System.Convert.ToString( CSROrderMsg.RequestHeader.ORNSeq ) );\r\nSystem.Diagnostics.Debug.WriteLine( \"\\n</BROKER>\\n\" )'",
        "runAfter": {
          "Listen_For_Orders_Join": [
            "SUCCEEDED"
          ]
        }
      },
      "Assign_Destination": {
        "type": "Compose",
        "inputs": "@'CSRPort(Microsoft.XLANGs.BaseTypes.Address) = CSROrderMsg.Header.SourceSystem'",
        "runAfter": {
          "TRACE": [
            "SUCCEEDED"
          ]
        }
      },
      "Order_Handling_Scope": {
        "type": "Scope",
        "actions": {
          "Message_Construction_Scope": {
            "type": "Scope",
            "actions": {
              "Construct_History_Msg_ea2ee5ca": {
                "type": "Xslt",
                "inputs": {
                  "content": "@triggerBody()",
                  "map": {
                    "name": "CSR_OrderRequest_To_SQLHistoryInsert",
                    "type": "Xslt"
                  },
                  "transformOptions": "ApplyXsltTemplates"
                },
                "runAfter": {}
              },
              "Construct_Servicing_Msg_1c146960": {
                "type": "Xslt",
                "inputs": {
                  "content": "@triggerBody()",
                  "map": {
                    "name": "CSR_OrderRequest_To_Servicing_OrderRequest",
                    "type": "Xslt"
                  },
                  "transformOptions": "ApplyXsltTemplates"
                },
                "runAfter": {
                  "Construct_History_Msg_ea2ee5ca": [
                    "SUCCEEDED"
                  ]
                }
              },
              "Construct_Confirmation_a4d42386": {
                "type": "Compose",
                "inputs": "@'CSRConfMsg = CSROrderMsg;\r\nCSRConfMsg(Microsoft.Samples.BizTalk.SouthridgeVideo.Schemas.Status) = \"ACCEPTED\"'",
                "runAfter": {
                  "Construct_Servicing_Msg_1c146960": [
                    "SUCCEEDED"
                  ]
                }
              },
              "Construct_OrderMsg_4b4da5ef": {
                "type": "Xslt",
                "inputs": {
                  "content": "@triggerBody()",
                  "map": {
                    "name": "CSR_OrderRequest_To_Order",
                    "type": "Xslt"
                  },
                  "transformOptions": "ApplyXsltTemplates"
                },
                "runAfter": {
                  "Construct_Confirmation_a4d42386": [
                    "SUCCEEDED"
                  ]
                }
              },
              "Catch_Message_Construction_Exception": {
                "type": "Scope",
                "actions": {
                  "Failure": {
                    "type": "Compose",
                    "inputs": "@'FailureReason = \"Message Construction Failed because: \" + MessageConstructionEx.Message'",
                    "runAfter": {}
                  },
                  "ThrowException": {
                    "type": "Terminate",
                    "inputs": {
                      "runStatus": "Failed",
                      "runError": {
                        "code": "Terminated",
                        "message": ""
                      }
                    },
                    "runAfter": {
                      "Failure": [
                        "SUCCEEDED"
                      ]
                    }
                  }
                },
                "runAfter": {
                  "Construct_OrderMsg_4b4da5ef": [
                    "FAILED",
                    "TIMEDOUT",
                    "SKIPPED"
                  ]
                }
              }
            },
            "runAfter": {}
          },
          "Send_Scope": {
            "type": "Scope",
            "actions": {
              "Atomic_Send_Scope": {
                "type": "Scope",
                "actions": {
                  "BAM_Continuation": {
                    "type": "Compose",
                    "inputs": "@'// Continuation\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.ActivateContinuation(\r\n                ActivityID,                         // Activity ID\r\n                CSROrderMsg.Header.ReqId);          // Request ID'",
                    "runAfter": {}
                  },
                  "BAM_Relationship": {
                    "type": "Compose",
                    "inputs": "@'// Relationship\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.ActivateRelationship(\r\n               ActivityID,                         // Current Activity ID\r\n               CSROrderMsg.Header.ReqId);          // Request ID'",
                    "runAfter": {
                      "BAM_Continuation": [
                        "SUCCEEDED"
                      ]
                    }
                  },
                  "Insert_to_History": {
                    "type": "Http",
                    "inputs": {
                      "method": "POST",
                      "uri": "http://localhost/service",
                      "body": "@triggerBody()",
                      "headers": {
                        "Content-Type": "application/json"
                      }
                    },
                    "runAfter": {
                      "BAM_Relationship": [
                        "SUCCEEDED"
                      ]
                    }
                  },
                  "To_Servicing_System": {
                    "type": "Http",
                    "inputs": {
                      "method": "POST",
                      "uri": "http://localhost/service",
                      "body": "@triggerBody()",
                      "headers": {
                        "Content-Type": "application/json"
                      }
                    },
                    "runAfter": {
                      "Insert_to_History": [
                        "SUCCEEDED"
                      ]
                    }
                  },
                  "Post_Response": {
                    "type": "Http",
                    "inputs": {
                      "method": "POST",
                      "uri": "http://localhost/service",
                      "body": "@triggerBody()",
                      "headers": {
                        "Content-Type": "application/json"
                      }
                    },
                    "runAfter": {
                      "To_Servicing_System": [
                        "SUCCEEDED"
                      ]
                    }
                  },
                  "To_Order_Mgr": {
                    "type": "Http",
                    "inputs": {
                      "method": "POST",
                      "uri": "http://localhost/service",
                      "body": "@triggerBody()",
                      "headers": {
                        "Content-Type": "application/json"
                      }
                    },
                    "runAfter": {
                      "Post_Response": [
                        "SUCCEEDED"
                      ]
                    }
                  }
                },
                "runAfter": {}
              },
              "Catch_Send_Exception": {
                "type": "Scope",
                "actions": {
                  "Failure_1": {
                    "type": "Compose",
                    "inputs": "@'FailureReason = \"Send failed because: \" + SendEx.Message'",
                    "runAfter": {}
                  },
                  "Throw_Exception": {
                    "type": "Terminate",
                    "inputs": {
                      "runStatus": "Failed",
                      "runError": {
                        "code": "Terminated",
                        "message": ""
                      }
                    },
                    "runAfter": {
                      "Failure_1": [
                        "SUCCEEDED"
                      ]
                    }
                  }
                },
                "runAfter": {
                  "Atomic_Send_Scope": [
                    "FAILED",
                    "TIMEDOUT",
                    "SKIPPED"
                  ]
                }
              }
            },
            "runAfter": {
              "Message_Construction_Scope": [
                "SUCCEEDED"
              ]
            }
          },
          "Post_BAM_Events": {
            "type": "Scope",
            "actions": {
              "BAM_Post_History": {
                "type": "Compose",
                "inputs": "@'// [BAM] Update Activity [Customer Order Request] with [Posted to History DB]\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.PostedToHistory( ActivityID )'",
                "runAfter": {}
              },
              "BAM_Post_Services": {
                "type": "Compose",
                "inputs": "@'// [BAM] Update Activity [Customer Order Request] with [Posted to Servicing]\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.PostedToServicing( ActivityID )'",
                "runAfter": {
                  "BAM_Post_History": [
                    "SUCCEEDED"
                  ]
                }
              },
              "BAM_Reply_CSR": {
                "type": "Compose",
                "inputs": "@'// [BAM] Update Activity [Customer Order Request] with [Reply to CSR]\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.RepliedToRequester( ActivityID )'",
                "runAfter": {
                  "BAM_Post_Services": [
                    "SUCCEEDED"
                  ]
                }
              },
              "BAM_End": {
                "type": "Compose",
                "inputs": "@'// [BAM] End Collecting BAM Data [Customer Order Request]\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.EndCollecting( ActivityID )'",
                "runAfter": {
                  "BAM_Reply_CSR": [
                    "SUCCEEDED"
                  ]
                }
              }
            },
            "runAfter": {
              "Send_Scope": [
                "SUCCEEDED"
              ]
            }
          },
          "Catch_Order_Exceptions": {
            "type": "Scope",
            "actions": {
              "Get_Exception_fb4f6448": {
                "type": "If",
                "expression": "@equals(variables('FailureReason'), 'Empty')",
                "actions": {
                  "Assign_Reason_7b925ec7": {
                    "type": "Compose",
                    "inputs": "@'FailureReason = \"Send failed because: \" + OrderEx.Message'",
                    "runAfter": {}
                  }
                },
                "else": {
                  "actions": {}
                },
                "runAfter": {}
              },
              "Log_Error": {
                "type": "Compose",
                "inputs": "@concat('PostError( \"OrderBroker terminated because: \"', variables('FailureReason'))",
                "runAfter": {
                  "Get_Exception_fb4f6448": [
                    "SUCCEEDED"
                  ]
                }
              },
              "BAM_Error": {
                "type": "Compose",
                "inputs": "@'// [BAM] Update Activity [Customer Order Request] with [Error]\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.ErrorOccurred( ActivityID, FailureReason )'",
                "runAfter": {
                  "Log_Error": [
                    "SUCCEEDED"
                  ]
                }
              },
              "BAM_End_1": {
                "type": "Compose",
                "inputs": "@'// [BAM] End Collecting BAM Data [Customer Order Request]\r\n\r\nMicrosoft.Samples.BizTalk.SouthridgeVideo.ServiceLevelTracking.CustomerOrderRequest.EndCollecting( ActivityID )'",
                "runAfter": {
                  "BAM_Error": [
                    "SUCCEEDED"
                  ]
                }
              },
              "Construct_Failure_1454de9d": {
                "type": "Compose",
                "inputs": "@'CSRConfMsg = CSROrderMsg;\r\nCSRConfMsg(Microsoft.Samples.BizTalk.SouthridgeVideo.Schemas.Status) = \"NOTACCEPTED\";\r\nCSRConfMsg(Microsoft.Samples.BizTalk.SouthridgeVideo.Schemas.Error) = FailureReason'",
                "runAfter": {
                  "BAM_End_1": [
                    "SUCCEEDED"
                  ]
                }
              },
              "Return_Denial": {
                "type": "Http",
                "inputs": {
                  "method": "POST",
                  "uri": "http://localhost/service",
                  "body": "@triggerBody()",
                  "headers": {
                    "Content-Type": "application/json"
                  }
                },
                "runAfter": {
                  "Construct_Failure_1454de9d": [
                    "SUCCEEDED"
                  ]
                }
              },
              "Terminate": {
                "type": "Terminate",
                "inputs": {
                  "runStatus": "Failed",
                  "runError": {
                    "code": "Terminated",
                    "message": "FailureReason;"
                  }
                },
                "runAfter": {
                  "Return_Denial": [
                    "SUCCEEDED"
                  ]
                }
              }
            },
            "runAfter": {
              "Post_BAM_Events": [
                "FAILED",
                "TIMEDOUT",
                "SKIPPED"
              ]
            }
          }
        },
        "runAfter": {
          "Assign_Destination": [
            "SUCCEEDED"
          ]
        }
      },
      "DefaultSendPort": {
        "type": "ServiceProvider",
        "inputs": {
          "parameters": {
            "entityName": "queue",
            "message": "@triggerBody()",
            "sessionId": "",
            "contentType": "application/json"
          },
          "serviceProviderConfiguration": {
            "connectionName": "servicebus",
            "operationId": "sendMessage",
            "serviceProviderId": "/serviceProviders/serviceBus"
          }
        },
        "runAfter": {
          "Order_Handling_Scope": [
            "SUCCEEDED"
          ]
        }
      }
    },
    "outputs": {},
    "metadata": {
      "detectedPatterns": [
        {
          "name": "Message Translator",
          "description": "Transform message format from one schema to another",
          "recommendation": "Use Data Mapper for visual transformations, Parse XML/Compose XML for schema validation, or Liquid templates for complex mapping"
        },
        {
          "name": "Exception Handling & Compensation",
          "description": "Handle errors and perform compensating actions",
          "recommendation": "Use Scope action with Configure Run After for error handling"
        }
      ],
      "optimizationApplied": true,
      "generatedBy": "BizTalk to Logic Apps Refactoring Tool",
      "generatedAt": "2026-02-15T15:30:13.0756938Z"
    }
  }
}