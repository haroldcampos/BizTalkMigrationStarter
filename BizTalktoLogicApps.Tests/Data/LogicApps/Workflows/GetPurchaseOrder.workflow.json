{
  "kind": "Stateful",
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "triggers": {
      "When_called_from_parent_workflow": {
        "type": "Request",
        "kind": "Http",
        "description": "Migrated from BizTalk WCF endpoint - BizTalk Adapter: HTTP",
        "metadata": {
          "biztalkTransportType": "HTTP"
        }
      }
    },
    "actions": {
      "shouldTerminate": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "shouldTerminate",
              "type": "boolean",
              "value": false
            }
          ]
        },
        "runAfter": {}
      },
      "terminateMessage": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "terminateMessage",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "shouldTerminate": [
            "SUCCEEDED"
          ]
        }
      },
      "retryCount": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "retryCount",
              "type": "integer",
              "value": 0
            }
          ]
        },
        "runAfter": {
          "terminateMessage": [
            "SUCCEEDED"
          ]
        }
      },
      "brokerID": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "brokerID",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "retryCount": [
            "SUCCEEDED"
          ]
        }
      },
      "orderID": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "orderID",
              "type": "string",
              "value": ""
            }
          ]
        },
        "runAfter": {
          "brokerID": [
            "SUCCEEDED"
          ]
        }
      },
      "OrderMessage": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "OrderMessage",
              "type": "object",
              "value": null
            }
          ]
        },
        "runAfter": {
          "orderID": [
            "SUCCEEDED"
          ]
        }
      },
      "bFailure": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "bFailure",
              "type": "boolean",
              "value": false
            }
          ]
        },
        "runAfter": {
          "OrderMessage": [
            "SUCCEEDED"
          ]
        }
      },
      "IntializeOutMessage_c1a73359": {
        "type": "Compose",
        "inputs": "@'OrderMessage = Microsoft.Samples.BizTalk.Litware.Utilities.ResourceHelper.GetEmptyOrderMessage()'",
        "runAfter": {
          "bFailure": [
            "SUCCEEDED"
          ]
        }
      },
      "RequestOrderMessage_8e40e678": {
        "type": "Xslt",
        "inputs": {
          "content": "@triggerBody()",
          "map": {
            "name": "PurchaseOrder_To_Inquiry",
            "type": "Xslt"
          },
          "transformOptions": "ApplyXsltTemplates"
        },
        "runAfter": {
          "IntializeOutMessage_c1a73359": [
            "SUCCEEDED"
          ]
        }
      },
      "Until": {
        "type": "Until",
        "expression": "@greaterOrEquals(variables('retryCount'), 3)",
        "limit": {
          "count": 3,
          "timeout": "PT1H"
        },
        "actions": {
          "GetOrder": {
            "type": "Scope",
            "actions": {
              "SendOrderRequest": {
                "type": "Http",
                "inputs": {
                  "method": "POST",
                  "uri": "http://localhost/service",
                  "body": "@body('RequestOrderMessage_8e40e678')",
                  "headers": {
                    "Content-Type": "application/json"
                  }
                },
                "runAfter": {}
              },
              "ReceiveOrder": {
                "type": "Compose",
                "inputs": "// Unmapped: Response Receive response from GetOrderPort (BizTalk correlation pattern - requires manual configuration)",
                "runAfter": {
                  "SendOrderRequest": [
                    "SUCCEEDED"
                  ]
                }
              },
              "Breakloop": {
                "type": "Compose",
                "inputs": "@'retryCount = 3'",
                "runAfter": {
                  "ReceiveOrder": [
                    "SUCCEEDED"
                  ]
                }
              },
              "CatchSystemException": {
                "type": "Scope",
                "actions": {
                  "Count": {
                    "type": "Compose",
                    "inputs": "@'retryCount = retryCount + 1'",
                    "runAfter": {}
                  },
                  "Terminate_a4e666fa": {
                    "type": "If",
                    "expression": "@less(variables('retryCount'), 3)",
                    "actions": {
                      "Log_Susp_Error_99258df7": {
                        "type": "Compose",
                        "inputs": "@concat('WriteEntry(\"Litware Scenario\", \"Failed to get order \"', variables('orderID'), ' for user ', variables('brokerID'), '. Orchestration suspended due to error ', 'Warning')",
                        "runAfter": {}
                      },
                      "Set_shouldTerminate_Suspend_09a86953": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "shouldTerminate",
                          "value": true
                        },
                        "runAfter": {
                          "Log_Susp_Error_99258df7": [
                            "SUCCEEDED"
                          ]
                        }
                      },
                      "Set_terminateMessage_Suspend_09a86953": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "terminateMessage",
                          "value": "\"Please verify why we failed to get order.\";"
                        },
                        "runAfter": {
                          "Set_shouldTerminate_Suspend_09a86953": [
                            "SUCCEEDED"
                          ]
                        }
                      }
                    },
                    "else": {
                      "actions": {
                        "Log_Intervention_Error_c6eb33cc": {
                          "type": "Compose",
                          "inputs": "@concat('WriteEntry(\"Litware Scenario\", \"Failed to get order \"', variables('orderID'), ' for user ', variables('brokerID'), '. Orchestration suspended due to error ', 'Error')",
                          "runAfter": {}
                        },
                        "Intervention_28d502eb": {
                          "type": "Compose",
                          "inputs": "@'bFailure = true'",
                          "runAfter": {
                            "Log_Intervention_Error_c6eb33cc": [
                              "SUCCEEDED"
                            ]
                          }
                        }
                      }
                    },
                    "runAfter": {
                      "Count": [
                        "SUCCEEDED"
                      ]
                    }
                  }
                },
                "runAfter": {
                  "Breakloop": [
                    "FAILED",
                    "TIMEDOUT",
                    "SKIPPED"
                  ]
                }
              },
              "CatchException": {
                "type": "Scope",
                "actions": {
                  "Count_1": {
                    "type": "Compose",
                    "inputs": "@'retryCount = retryCount + 1'",
                    "runAfter": {}
                  },
                  "Terminate_7163dd5b": {
                    "type": "If",
                    "expression": "@less(variables('retryCount'), 3)",
                    "actions": {
                      "Log_Susp_Error_e2de675b": {
                        "type": "Compose",
                        "inputs": "@concat('WriteEntry(\"Litware Scenario\", \"Failed to get order \"', variables('orderID'), ' for user ', variables('brokerID'), '. Orchestration suspended due to error ', 'exp')",
                        "runAfter": {}
                      },
                      "Set_shouldTerminate_Suspend_0e569111": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "shouldTerminate",
                          "value": true
                        },
                        "runAfter": {
                          "Log_Susp_Error_e2de675b": [
                            "SUCCEEDED"
                          ]
                        }
                      },
                      "Set_terminateMessage_Suspend_0e569111": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "terminateMessage",
                          "value": "\"Please verify why we failed to get order.\";"
                        },
                        "runAfter": {
                          "Set_shouldTerminate_Suspend_0e569111": [
                            "SUCCEEDED"
                          ]
                        }
                      }
                    },
                    "else": {
                      "actions": {
                        "Log_Intervention_Error_a081db9f": {
                          "type": "Compose",
                          "inputs": "@concat('WriteEntry(\"Litware Scenario\", \"Failed to get order \"', variables('orderID'), ' for user ', variables('brokerID'), '. Orchestration suspended due to error ', 'exp')",
                          "runAfter": {}
                        },
                        "Intervention_cfcd2c58": {
                          "type": "Compose",
                          "inputs": "@'bFailure = true'",
                          "runAfter": {
                            "Log_Intervention_Error_a081db9f": [
                              "SUCCEEDED"
                            ]
                          }
                        }
                      }
                    },
                    "runAfter": {
                      "Count_1": [
                        "SUCCEEDED"
                      ]
                    }
                  }
                },
                "runAfter": {
                  "Breakloop": [
                    "FAILED",
                    "TIMEDOUT",
                    "SKIPPED"
                  ]
                }
              }
            },
            "runAfter": {}
          }
        },
        "runAfter": {
          "RequestOrderMessage_8e40e678": [
            "SUCCEEDED"
          ]
        }
      },
      "DefaultSendPort": {
        "type": "ServiceProvider",
        "inputs": {
          "parameters": {
            "entityName": "queue",
            "message": "@triggerBody()",
            "sessionId": "",
            "contentType": "application/json"
          },
          "serviceProviderConfiguration": {
            "connectionName": "servicebus",
            "operationId": "sendMessage",
            "serviceProviderId": "/serviceProviders/serviceBus"
          }
        },
        "runAfter": {
          "Check_Terminate_Until": [
            "SUCCEEDED"
          ]
        }
      },
      "Check_Terminate_Until": {
        "type": "If",
        "expression": "@equals(variables('shouldTerminate'), true)",
        "actions": {
          "Terminate_Until": {
            "type": "Terminate",
            "inputs": {
              "runStatus": "Failed",
              "runError": {
                "code": "Terminated",
                "message": "@variables('terminateMessage')"
              }
            },
            "runAfter": {}
          }
        },
        "else": {
          "actions": {}
        },
        "runAfter": {
          "Until": [
            "SUCCEEDED",
            "FAILED",
            "TIMEDOUT"
          ]
        }
      }
    },
    "outputs": {}
  }
}