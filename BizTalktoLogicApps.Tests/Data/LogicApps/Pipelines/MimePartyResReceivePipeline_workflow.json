{
  "kind": "Stateful",
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "triggers": {
      "pipelinereceive": {
        "type": "Request",
        "kind": "Http"
      }
    },
    "actions": {
      "Decode": {
        "type": "Scope",
        "actions": {
          "MicrosoftBizTalkComponentMIMESMIMEDecoder": {
            "type": "InvokeFunction",
            "inputs": {
              "functionName": "DecodeMimeSmimeMessage",
              "parameters": {
                "messageContent": "@triggerBody()?['$content']",
                "validateSignature": "true",
                "decryptMessage": "true",
                "AllowNonMIMEMessage": "false"
              }
            },
            "metadata": {
              "comment": "// Component: MIME/SMIME Decoder\r\n// Description: ONLY out-of-box component that handles multi-part messages. Supports 7bit, 8bit, binary, quoted-printable, UUencode, and base64 decoding. Decrypts and validates signatures using certificates.\r\n// Behavior: Parses multi-part MIME into multi-part BizTalk message. Decrypts using personal certificate store of service account. Validates signatures from Address Book or message. Associates decryption certificate thumbprint with message (subscribing services must use host with that certificate). Identifies BodyPart by: 1) Content-Description='body' 2) Content-Type='text/xml' 3) Content-Type='text/' 4) First part. Other components (XML Disassembler) only process body part.\r\n// Message Flow: 1 multi-part MIME message in → 1 multi-part BizTalk message out (maintains part order)\r\n// Properties:\r\n//   AllowNonMIMEMessage = false\n// ?? WARNING: MIME processing requires Azure Functions\n// IMPLEMENTATION: Deploy Azure Function with MimeKit library\n// FUNCTION NAME: DecodeMimeSmimeMessage\n// Stage: Decode (All)"
            },
            "runAfter": {}
          }
        },
        "runAfter": {}
      },
      "Disassemble": {
        "type": "Scope",
        "actions": {
          "MicrosoftBizTalkComponentXmlDasmComp": {
            "type": "Foreach",
            "foreach": "@triggerBody()?['items']",
            "actions": {
              "ParseXMLwithSchema": {
                "type": "XmlParse",
                "inputs": {
                  "content": "@items('MicrosoftBizTalkComponentXmlDasmComp')?['$content']",
                  "schema": {
                    "source": "LogicApp",
                    "name": "SCHEMA_NAME_HERE"
                  },
                  "xmlReaderSettings": {
                    "dtdProcessing": "Prohibit",
                    "xmlNormalization": true,
                    "ignoreWhitespace": true,
                    "ignoreProcessingInstructions": true
                  },
                  "jsonWriterSettings": {
                    "ignoreAttributes": false,
                    "useFullyQualifiedNames": false
                  }
                },
                "metadata": {
                  "comment": "// Use 'Parse XML with schema' action\n// ACTION REQUIRED:\n// 1. Upload XSD schema to Logic App artifacts\n// 2. Select schema in Parse XML action\n// 3. Configure XPath expressions for property extraction\n// 4. Map promoted properties from BizTalk schema annotations"
                },
                "runAfter": {}
              }
            },
            "runtimeConfiguration": {
              "concurrency": {
                "repetitions": 20
              }
            },
            "runAfter": {}
          }
        },
        "runAfter": {
          "Decode": [
            "SUCCEEDED"
          ]
        }
      },
      "ResolveParty": {
        "type": "Scope",
        "actions": {
          "MicrosoftBizTalkComponentPartyRes": {
            "type": "InvokeFunction",
            "inputs": {
              "functionName": "ResolvePartner",
              "parameters": {
                "certificateThumbprint": "@triggerBody()?['CertificateThumbprint']",
                "windowsSID": "@triggerBody()?['WindowsSID']",
                "resolutionMode": "CertificateThenSID",
                "AllowBySID": "true",
                "AllowByCertName": "true"
              }
            },
            "metadata": {
              "comment": "// Component: Party Resolution\r\n// Description: Maps sender certificate or security identifier (SID) to configured BizTalk Server party. Uses WindowsUser and SignatureCertificate context properties.\r\n// Behavior: Reads WindowsUser and SignatureCertificate from message context. Resolves party by certificate (if enabled) or by SID. Sets SourcePartyID as OriginatorPID if resolved and host is Authentication Trusted. If resolution fails, stamps OriginatorPID as 's-1-5-7' (anonymous user). Resolution order: Certificate first (if By Certificate = True), then SID (if By SID = True).\r\n// Message Flow: 1 message in → 1 message out\r\n// Properties:\r\n//   AllowBySID = true\r\n//   AllowByCertName = true\n// MIGRATION: Implement via Azure Functions with data store lookup\n// FUNCTION NAME: ResolvePartner\n// DATA STORE: Azure Table Storage or SQL Database\n// Stage: ResolveParty (All)"
            },
            "runAfter": {}
          }
        },
        "runAfter": {
          "Disassemble": [
            "SUCCEEDED"
          ]
        }
      }
    },
    "outputs": {}
  }
}